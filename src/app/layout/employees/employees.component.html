<app-loading-indicator
  [isLoading]="isLoading"
  message="Загрузка">
</app-loading-indicator>
<div class="main-container">
  <div class="search-with-add">
    <div class="search-container">
      <fa-icon [icon]="faSearch" [class.focused]="isSearchFocused" class="search-icon"></fa-icon>
      <input
        (focus)="onSearchFocus()"
        (blur)="onSearchBlur()"
        type="text"
        placeholder="Найти сотрудника"
        class="search-input"
        [(ngModel)]="searchQuery"
        (input)="applyFilters()">
    </div>
    <button class="btn add-item-button" (click)="openAddModal()">
      <fa-icon [icon]="faPlus"></fa-icon>
      <fa-icon [icon]="faUser" style="margin-left: 5px;"></fa-icon>
    </button>
  </div>

  <div class="table-container">
    <table class="items-table">
      <thead>
      <tr>
        <th>ФИО</th>
        <th>Должность</th>
        <th>
          <div class="sortable-header" style="display: flex;">
            <span>Квалификация</span>
            <div (click)="toggleSort('qualification')" style="display: flex; flex-direction: column; margin-top: 4px; cursor: pointer;">
              <fa-icon class="sort-icon-up" [icon]="faSortUp"
                       [class.active]="sortField === 'qualification' && sortDirection === 'asc'"></fa-icon>
              <fa-icon class="sort-icon-down" [icon]="faSortDown"
                       [class.active]="sortField === 'qualification' && sortDirection === 'desc'"></fa-icon>
            </div>
          </div>
        </th>
        <th>
          <div class="filterable-header">
            <span>Команда</span>
            <fa-icon class="filter-icon" [icon]="faFilter"
                     (click)="toggleFilter('team')"
                     [class.active]="activeFilter === 'team' || hasActiveTeamFilter()"></fa-icon>
            <div class="filter-popup" *ngIf="activeFilter === 'team'">
              <div class="filter-options">
                <div class="filter-option" *ngFor="let team of teams">
                  <input type="checkbox"
                         [id]="'team-' + team.id"
                         [checked]="filterValues['teamId']?.includes(team.id)"
                         (change)="onFilterChange('teamId', team.id, $event)">
                  <label [for]="'team-' + team.id">{{ team.name }}</label>
                </div>
              </div>
            </div>
          </div>
        </th>
        <th>
          <div class="filterable-header">
            <span>Статус</span>
            <fa-icon class="filter-icon" [icon]="faFilter"
                     (click)="toggleFilter('status')"
                     [class.active]="activeFilter === 'status' || hasActiveStatusFilter()"></fa-icon>
            <div class="filter-popup" *ngIf="activeFilter === 'status'">
              <div class="filter-options">
                <div class="filter-option">
                  <input type="checkbox"
                         id="active"
                         [checked]="filterValues['isActive']?.includes(true)"
                         (change)="onFilterChange('isActive', true, $event)">
                  <label for="active">Активен</label>
                </div>
                <div class="filter-option">
                  <input type="checkbox"
                         id="inactive"
                         [checked]="filterValues['isActive']?.includes(false)"
                         (change)="onFilterChange('isActive', false, $event)">
                  <label for="inactive">Неактивен</label>
                </div>
              </div>
            </div>
          </div>
        </th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let emp of filteredEmployees">
        <td>{{ emp.fullName }}</td>
        <td>{{ emp.position }}</td>
        <td>{{ emp.qualification }}</td>
        <td>{{ getTeamName(emp.team.id) }}</td>
        <td>
          <span class="status-badge" [class.active]="emp.active" [class.inactive]="!emp.active">
            {{ emp.active ? 'Активен' : 'Неактивен' }}
          </span>
        </td>
        <td>
          <div class="actions">
            <fa-icon class="edit-button" [icon]="faEdit" (click)="openEditModal(emp)"></fa-icon>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Модальное окно добавления/редактирования сотрудника -->
<div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingEmployee ? 'Редактировать сотрудника' : 'Добавить сотрудника' }}</h3>
      <fa-icon class="close-btn" [icon]="faXmark" (click)="closeModal()"></fa-icon>
    </div>

    <form class="modal-form" (ngSubmit)="saveEmployee()" #employeeForm="ngForm">
      <!-- ФИО -->
      <div class="form-group">
        <input type="text"
               [(ngModel)]="currentEmployee.fullName"
               name="fullName"
               required
               placeholder="ФИО сотрудника"
               #fullName="ngModel"
               [class.error]="fullName.invalid && (fullName.dirty || fullName.touched)">
        <div class="error-message" *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">
          ФИО обязательно
        </div>
      </div>

      <!-- Должность -->
      <div class="form-group">
        <input type="text"
               [(ngModel)]="currentEmployee.position"
               name="position"
               required
               placeholder="Должность"
               #position="ngModel"
               [class.error]="position.invalid && (position.dirty || position.touched)">
        <div class="error-message" *ngIf="position.invalid && (position.dirty || position.touched)">
          Должность обязательна
        </div>
      </div>

      <!-- Квалификация -->
      <div class="form-group">
        <input type="number"
               [(ngModel)]="currentEmployee.qualification"
               name="qualification"
               required
               min="1"
               max="5"
               placeholder="Квалификация (1-5)"
               #qualification="ngModel"
               [class.error]="qualification.invalid && (qualification.dirty || qualification.touched)">
        <div class="error-message" *ngIf="qualification.invalid && (qualification.dirty || qualification.touched)">
          <span *ngIf="qualification.errors?.['required']">Квалификация обязательна</span>
          <span *ngIf="qualification.errors?.['min'] || qualification.errors?.['max']">
            Квалификация должна быть от 1 до 5
          </span>
        </div>
      </div>

      <!-- Команда -->
      <div class="form-group">
        <select
          [(ngModel)]="currentEmployee.teamId"
          name="teamId"
          #teamId="ngModel"
          [class.error]="!currentEmployee.teamId && (teamId.dirty || teamId.touched)">
          <option [ngValue]="null" disabled selected>Выберите команду</option>
          <option *ngFor="let team of teams" [ngValue]="team.id">{{ team.name }}</option>
        </select>
        <div class="error-message" *ngIf="!currentEmployee.teamId && (teamId.dirty || teamId.touched)">
          Команда обязательна
        </div>
      </div>

      <!-- Статус -->
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox"
                 [(ngModel)]="currentEmployee.active"
                 name="isActive"
                 style="margin: 0;">
          Активен
        </label>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn" [disabled]="!isFormValid()">
          {{ editingEmployee ? 'Сохранить' : 'Добавить' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Модальное окно подтверждения удаления сотрудника -->
<app-confirm-delete-modal
  [isOpen]="isDeleteModalOpen"
  [title]="'Подтверждение удаления'"
  [message]="'Вы уверены, что хотите удалить этого сотрудника?'"
  [itemName]="employeeToDelete?.fullName || ''"
  [confirmButtonText]="'Удалить'"
  [cancelButtonText]="'Отмена'"
  (confirm)="confirmDelete()"
  (close)="closeDeleteModal()">
</app-confirm-delete-modal>

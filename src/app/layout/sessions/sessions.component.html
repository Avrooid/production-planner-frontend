<app-loading-indicator
  [isLoading]="isLoading"
  [message]="'Загрузка'">
</app-loading-indicator>
<div class="main-container">
  <div class="teams-layout">
    <!-- Левая панель со списком команд -->
    <div class="teams-list">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <span style="font-size: 20px; font-weight: 600;">Сессии</span>
        <button class="btn" style="padding: 5px; margin-left: 20px;" (click)="openAddSessionModal()">
          <fa-icon [icon]="faPlus"></fa-icon>
        </button>
      </div>
      <div *ngFor="let session of productionSessions; let i = index"
           [class.active]="selectedSessionIndex === i"
           (click)="selectSession(i)"
           class="team-card">
        <div style="width: 70%;">
          <div class="team-name">{{ session.name }}</div>
          <div class="team-meta">{{ session.startDate}} - {{ session.endDate }}</div>
        </div>
        <div style="width: 30%; display: flex; flex-direction: row; align-items: center;">
          <fa-icon class="edit-button" [icon]="faEdit" (click)="openEditSessionModal(session, $event)"></fa-icon>
          <fa-icon class="delete-button" [icon]="faTrash" (click)="openDeleteSessionModal(session, $event)"></fa-icon>
        </div>
      </div>
    </div>

    <!-- Правая панель с таблицей -->
    <div class="team-details" *ngIf="selectedSession">
      <div class="tabs">
        <button
          class="tab-btn"
          [class.active]="activeTab === 'orders'"
          (click)="activeTab = 'orders'">
          Заказы
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'optimization'"
          (click)="activeTab = 'optimization'">
          Оптимизация
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'optimizationResults'"
          (click)="activeTab = 'optimizationResults'">
          Результаты оптимизаций
        </button>
      </div>
      <div *ngIf="activeTab === 'orders'">
        <div class="search-with-add">
          <button class="btn add-item-button" (click)="openAddOrderModal()">
            <fa-icon [icon]="faPlus"></fa-icon>
            <fa-icon [icon]="faClock" style="margin-left: 5px;"></fa-icon>
          </button>
        </div>

        <div class="table-container">
          <table class="items-table">
            <thead>
            <tr>
              <th>Изделие</th>
              <th>Тип производства</th>
              <th>Количество</th>
              <th>Дедлайн</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let sessionOrder of selectedSession.sessionOrders">
              <td>{{ sessionOrder.product.name }}</td>
              <td>
              <span class="type-badge" [class.production]="sessionOrder.productionType === 'SERIAL'"
                    [class.assembly]="sessionOrder.productionType === 'NON_SERIAL'">
                {{ sessionOrder.productionType === 'SERIAL' ? 'Серийное' : 'Несирийное' }}
              </span>
              </td>
              <td>{{ getDisplayQuantity(sessionOrder) }}</td>
              <td>{{ sessionOrder.deadlineDate }}</td>
              <td>
                <div class="actions">
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div *ngIf="activeTab === 'optimization'">
        <div class="search-with-add">
          <button class="btn add-item-button" (click)="openOptimizationModal(selectedSession.id)">
            <fa-icon [icon]="faPlus"></fa-icon>
            <fa-icon [icon]="faCalculator" style="margin-left: 5px;"></fa-icon>
          </button>
        </div>

        <div class="table-container">
          <table class="items-table">
            <thead>
            <tr>
              <th>Дата</th>
              <th>Версия модели</th>
              <th>kTD</th>
              <th>kU</th>
              <th>kO</th>
              <th>α</th>
              <th>β</th>
              <th>δ</th>
              <th>Комментарий</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let optimization of optimizationsBySession">
              <td>{{ optimization.runTimestamp }}</td>
              <td>{{ optimization.modelVersion }}</td>
              <td>{{ optimization.tardyDefaultK }}</td>
              <td>{{ optimization.underK }}</td>
              <td>{{ optimization.overK }}</td>
              <td>{{ optimization.alpha }}</td>
              <td>{{ optimization.beta }}</td>
              <td>{{ optimization.deltaBuffer }}</td>
              <td>{{ optimization.comment }}</td>
              <td>
                <div class="actions">
                  <fa-icon class="edit-button" [icon]="faEdit" (click)="openOptimizationModal(selectedSession.id, optimization)"></fa-icon>
                  <fa-icon class="edit-button" [icon]="faPlay" (click)="openEmployeeStatusModal(optimization.id)"></fa-icon>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div *ngIf="activeTab === 'optimizationResults'">
        <div class="table-container">
          <table class="items-table">
            <thead>
            <tr>
              <th>Дата выполения</th>
              <th>Общие часы</th>
              <th>Общее кол-во</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let optimizationResult of combinedOptimizations">
              <td>{{ optimizationResult.workDate }}</td>
              <td>{{ optimizationResult.totalHours }}</td>
              <td>{{ optimizationResult.totalQuantity }}</td>
              <td>
                <div class="actions">
                  <fa-icon class="edit-button" [icon]="faEye" (click)="openOptimizationResultModal(optimizationResult)"></fa-icon>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Если нет выбранной команды -->
      <div class="no-selection" *ngIf="!selectedSession">
        <p>Выберите сессию из списка слева</p>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для добавления/редактирования производственной сессии -->
<div class="modal-overlay" *ngIf="isSessionModalOpen" (click)="closeSessionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingSession ? 'Редактировать производственную сессию' : 'Добавить производственную сессию' }}</h3>
      <fa-icon class="close-btn" [icon]="faXmark" (click)="closeSessionModal()"></fa-icon>
    </div>

    <form class="modal-form" (ngSubmit)="saveSession()" #sessionForm="ngForm">
      <!-- Название сессии -->
      <div class="form-group">
        <label for="sessionName">Название сессии</label>
        <input
          type="text"
          id="sessionName"
          [(ngModel)]="currentSession.name"
          name="sessionName"
          required
          minlength="3"
          placeholder="Введите название сессии"
          #sessionName="ngModel"
          [class.error]="sessionName.invalid && (sessionName.dirty || sessionName.touched)">
        <div class="error-message" *ngIf="sessionName.invalid && (sessionName.dirty || sessionName.touched)">
          <span *ngIf="sessionName.errors?.['required']">Название обязательно</span>
          <span *ngIf="sessionName.errors?.['minlength']">Минимальная длина: 3 символа</span>
        </div>
      </div>

      <!-- Дата начала -->
      <div class="form-group">
        <label for="startDate">Дата начала</label>
        <input
          type="date"
          id="startDate"
          [(ngModel)]="currentSession.startDate"
          name="startDate"
          required
          #startDate="ngModel"
          [class.error]="startDate.invalid && (startDate.dirty || startDate.touched)">
        <div class="error-message" *ngIf="startDate.invalid && (startDate.dirty || startDate.touched)">
          Дата начала обязательна
        </div>
      </div>

      <div class="modal-actions">
        <button
          type="submit"
          class="btn"
          [disabled]="sessionForm.invalid">
          {{ editingSession ? 'Сохранить' : 'Добавить' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Модальное окно для добавления заказа к сессии -->
<div class="modal-overlay" *ngIf="isOrderModalOpen" (click)="closeOrderModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Добавить заказ к сессии</h3>
      <fa-icon class="close-btn" [icon]="faXmark" (click)="closeOrderModal()"></fa-icon>
    </div>

    <form class="modal-form" (ngSubmit)="saveOrder()" #orderForm="ngForm">
      <!-- Изделие -->
      <div class="form-group">
        <label for="orderProductId">Изделие</label>
        <select
          id="orderProductId"
          [(ngModel)]="currentOrder.productId"
          name="orderProductId"
          required
          #orderProductId="ngModel"
          [class.error]="orderProductId.invalid && (orderProductId.dirty || orderProductId.touched)">
          <option value="" disabled selected>Выберите изделие</option>
          <option *ngFor="let product of products" [value]="product.id">
            {{ product.name }}
          </option>
        </select>
        <div class="error-message" *ngIf="orderProductId.invalid && (orderProductId.dirty || orderProductId.touched)">
          Изделие обязательно
        </div>
      </div>

      <!-- Тип производства -->
      <div class="form-group">
        <label for="orderProductionType">Тип производства</label>
        <select
          id="orderProductionType"
          [(ngModel)]="currentOrder.productionType"
          name="orderProductionType"
          required
          #orderProductionType="ngModel"
          [class.error]="orderProductionType.invalid && (orderProductionType.dirty || orderProductionType.touched)">
          <option value="" disabled selected>Выберите тип производства</option>
          <option value="serial">Серийное</option>
          <option value="non_serial">Несерийное</option>
        </select>
        <div class="error-message" *ngIf="orderProductionType.invalid && (orderProductionType.dirty || orderProductionType.touched)">
          Тип производства обязателен
        </div>
      </div>

      <!-- Количество -->
      <div class="form-group">
        <label for="quantity">Количество</label>
        <input
          type="number"
          id="quantity"
          [(ngModel)]="currentOrder.quantity"
          name="quantity"
          min="1"
          required
          placeholder="Количество"
          #quantity="ngModel"
          [class.error]="quantity.invalid && (quantity.dirty || quantity.touched)">
        <div class="error-message" *ngIf="quantity.invalid && (quantity.dirty || quantity.touched)">
          <span *ngIf="quantity.errors?.['required']">Количество обязательно</span>
          <span *ngIf="quantity.errors?.['min']">Минимальное количество: 1</span>
        </div>
      </div>

      <!-- Крайний срок -->
      <div class="form-group">
        <label for="deadlineDate">Крайний срок</label>
        <input
          type="date"
          id="deadlineDate"
          [(ngModel)]="currentOrder.deadlineDate"
          name="deadlineDate"
          required
          #deadlineDate="ngModel"
          [class.error]="deadlineDate.invalid && (deadlineDate.dirty || deadlineDate.touched)">
        <div class="error-message" *ngIf="deadlineDate.invalid && (deadlineDate.dirty || deadlineDate.touched)">
          Крайний срок обязателен
        </div>
      </div>

      <!-- Источник -->
      <div class="form-group">
        <label for="source">Источник</label>
        <input
          type="text"
          id="source"
          [(ngModel)]="currentOrder.source"
          name="source"
          required
          placeholder="Источник заказа"
          #source="ngModel"
          [class.error]="source.invalid && (source.dirty || source.touched)">
        <div class="error-message" *ngIf="source.invalid && (source.dirty || source.touched)">
          Источник обязателен
        </div>
      </div>

      <div class="modal-actions">
        <button
          type="submit"
          class="btn"
          [disabled]="orderForm.invalid">
          Добавить заказ
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Модальное окно подтверждения удаления сессии -->
<app-confirm-delete-modal
  [isOpen]="isDeleteSessionModalOpen"
  [title]="'Подтверждение удаления'"
  [message]="'Вы уверены, что хотите удалить производственную сессию?'"
  [itemName]="sessionToDelete?.name || ''"
  [confirmButtonText]="'Удалить'"
  [cancelButtonText]="'Отмена'"
  (confirm)="confirmDeleteSession()"
  (close)="closeDeleteSessionModal()">
</app-confirm-delete-modal>

<app-confirm-delete-modal
  [isOpen]="isDeleteOrderModalOpen"
  [title]="'Подтверждение удаления'"
  [message]="'Вы уверены, что хотите удалить заказ из сессии?'"
  [itemName]="orderToDelete?.product?.name || ''"
  [confirmButtonText]="'Удалить'"
  [cancelButtonText]="'Отмена'"
  (confirm)="confirmDeleteOrder()"
  (close)="closeDeleteOrderModal()">
</app-confirm-delete-modal>


<div class="modal-overlay" *ngIf="isOptimizationModalOpen" (click)="closeOptimizationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingOptimization ? 'Редактировать оптимизацию' : 'Создать новую оптимизацию' }}</h3>
      <fa-icon class="close-btn" [icon]="faXmark" (click)="closeOptimizationModal()"></fa-icon>
    </div>

    <form class="modal-form" (ngSubmit)="runOptimization()" #optimizationForm="ngForm">
      <!-- Дата выполнения -->
      <div class="form-group">
        <label for="runTimestamp">Дата выполнения</label>
        <input
          type="date"
          id="runTimestamp"
          [(ngModel)]="currentOptimization.runTimestamp"
          name="runTimestamp"
          required
          #runTimestamp="ngModel"
          [class.error]="runTimestamp.invalid && (runTimestamp.dirty || runTimestamp.touched)">
        <div class="error-message" *ngIf="runTimestamp.invalid && (runTimestamp.dirty || runTimestamp.touched)">
          Дата выполнения обязательна
        </div>
      </div>

      <!-- Версия модели -->
      <div class="form-group">
        <label for="modelVersion">Версия модели</label>
        <select
          id="modelVersion"
          [(ngModel)]="currentOptimization.modelVersion"
          name="modelVersion"
          required
          #modelVersion="ngModel"
          [class.error]="modelVersion.invalid && (modelVersion.dirty || modelVersion.touched)">
          <option value="" disabled selected>Выберите версию модели</option>
          <option value="model-a">model-a</option>
          <option value="model-b">model-b</option>
        </select>
        <div class="error-message" *ngIf="modelVersion.invalid && (modelVersion.dirty || modelVersion.touched)">
          <span *ngIf="modelVersion.errors?.['required']">Выберите версию модели</span>
        </div>
      </div>

      <!-- Коэффициенты в две колонки -->
      <div class="form-row">
        <!-- kTardyDefault -->
        <div class="form-group">
          <label for="kTardyDefault">Коэффициент опоздания (kTardyDefault)</label>
          <input
            type="number"
            id="kTardyDefault"
            [(ngModel)]="currentOptimization.kTardyDefault"
            name="kTardyDefault"
            required
            step="0.001"
            min="0"
            placeholder="0.000"
            #kTardyDefault="ngModel"
            [class.error]="kTardyDefault.invalid && (kTardyDefault.dirty || kTardyDefault.touched)">
          <div class="error-message" *ngIf="kTardyDefault.invalid && (kTardyDefault.dirty || kTardyDefault.touched)">
            <span *ngIf="kTardyDefault.errors?.['required']">Коэффициент обязателен</span>
            <span *ngIf="kTardyDefault.errors?.['min']">Значение должно быть положительным</span>
          </div>
        </div>

        <!-- kUnder -->
        <div class="form-group">
          <label for="kUnder">Коэффициент недоиспользования (kUnder)</label>
          <input
            type="number"
            id="kUnder"
            [(ngModel)]="currentOptimization.kUnder"
            name="kUnder"
            required
            step="0.001"
            min="0"
            placeholder="0.000"
            #kUnder="ngModel"
            [class.error]="kUnder.invalid && (kUnder.dirty || kUnder.touched)">
          <div class="error-message" *ngIf="kUnder.invalid && (kUnder.dirty || kUnder.touched)">
            <span *ngIf="kUnder.errors?.['required']">Коэффициент обязателен</span>
            <span *ngIf="kUnder.errors?.['min']">Значение должно быть положительным</span>
          </div>
        </div>
      </div>

      <div class="form-row">
        <!-- kOver -->
        <div class="form-group">
          <label for="kOver">Коэффициент переиспользования (kOver)</label>
          <input
            type="number"
            id="kOver"
            [(ngModel)]="currentOptimization.kOver"
            name="kOver"
            required
            step="0.001"
            min="0"
            placeholder="0.000"
            #kOver="ngModel"
            [class.error]="kOver.invalid && (kOver.dirty || kOver.touched)">
          <div class="error-message" *ngIf="kOver.invalid && (kOver.dirty || kOver.touched)">
            <span *ngIf="kOver.errors?.['required']">Коэффициент обязателен</span>
            <span *ngIf="kOver.errors?.['min']">Значение должно быть положительным</span>
          </div>
        </div>

        <!-- alpha -->
        <div class="form-group">
          <label for="alpha">Коэффициент альфа (α)</label>
          <input
            type="number"
            id="alpha"
            [(ngModel)]="currentOptimization.alpha"
            name="alpha"
            required
            step="0.001"
            min="0"
            placeholder="0.000"
            #alpha="ngModel"
            [class.error]="alpha.invalid && (alpha.dirty || alpha.touched)">
          <div class="error-message" *ngIf="alpha.invalid && (alpha.dirty || alpha.touched)">
            <span *ngIf="alpha.errors?.['required']">Коэффициент обязателен</span>
            <span *ngIf="alpha.errors?.['min']">Значение должно быть положительным</span>
          </div>
        </div>
      </div>

      <div class="form-row">
        <!-- beta -->
        <div class="form-group">
          <label for="beta">Коэффициент бета (β)</label>
          <input
            type="number"
            id="beta"
            [(ngModel)]="currentOptimization.beta"
            name="beta"
            required
            step="0.001"
            min="0"
            placeholder="0.000"
            #beta="ngModel"
            [class.error]="beta.invalid && (beta.dirty || beta.touched)">
          <div class="error-message" *ngIf="beta.invalid && (beta.dirty || beta.touched)">
            <span *ngIf="beta.errors?.['required']">Коэффициент обязателен</span>
            <span *ngIf="beta.errors?.['min']">Значение должно быть положительным</span>
          </div>
        </div>

        <!-- deltaBuffer -->
        <div class="form-group">
          <label for="deltaBuffer">Буфер дельты (deltaBuffer)</label>
          <input
            type="number"
            id="deltaBuffer"
            [(ngModel)]="currentOptimization.deltaBuffer"
            name="deltaBuffer"
            required
            step="0.001"
            min="0"
            placeholder="0.000"
            #deltaBuffer="ngModel"
            [class.error]="deltaBuffer.invalid && (deltaBuffer.dirty || deltaBuffer.touched)">
          <div class="error-message" *ngIf="deltaBuffer.invalid && (deltaBuffer.dirty || deltaBuffer.touched)">
            <span *ngIf="deltaBuffer.errors?.['required']">Буфер обязателен</span>
            <span *ngIf="deltaBuffer.errors?.['min']">Значение должно быть положительным</span>
          </div>
        </div>
      </div>

      <!-- Комментарий -->
      <div class="form-group">
        <label for="comment">Комментарий</label>
        <textarea
          id="comment"
          [(ngModel)]="currentOptimization.comment"
          name="comment"
          rows="3"
          placeholder="Введите комментарий к оптимизации (опционально)"
          #comment="ngModel"
          [class.error]="comment.invalid && (comment.dirty || comment.touched)">
        </textarea>
      </div>

      <div class="modal-actions">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="optimizationForm.invalid">
          {{ editingOptimization ? 'Сохранить изменения' : 'Запустить оптимизацию' }}
        </button>
      </div>
    </form>
  </div>
</div>



<!-- Модальное окно -->
<!-- optimization-grouped-modal.component.html -->
<div *ngIf="selectedOptimizationCombined" class="opt-result-modal-overlay" (click)="closeOptimizationResultModal()">
  <div class="opt-result-modal-content" (click)="$event.stopPropagation()">

    <!-- Заголовок модального окна -->
    <div class="opt-result-modal-header">
      <h2 class="opt-result-modal-title">
        Оптимизация на {{ selectedOptimizationCombined.workDate | date:'dd.MM.yyyy' }}
      </h2>
      <button class="opt-result-modal-close" (click)="closeOptimizationResultModal()">&times;</button>
    </div>

    <!-- Тело модального окна -->
    <div class="opt-result-modal-body">

      <!-- Первая строка: Общая информация -->
      <div class="full-width-section">
        <div class="info-card rounded-card summary-card">
          <div class="card-header">
            <h3 class="card-title" style="margin-right: 10px;">Сводная информация</h3>
            <fa-icon [icon]="faChartPie" style="color: gray; font-size: 20px;"></fa-icon>
          </div>
          <div class="card-content">
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">Дата работы:</span>
                <span class="summary-value highlight">{{ selectedOptimizationCombined.workDate | date:'dd.MM.yyyy' }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Общее количество:</span>
                <span class="summary-value highlight">{{ selectedOptimizationCombined.totalQuantity | number:'1.2-2' }} шт</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Общие часы:</span>
                <span class="summary-value highlight">{{ selectedOptimizationCombined.totalHours | number:'1.2-2' }} ч</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Количество бригад:</span>
                <span class="summary-value highlight">{{ selectedOptimizationCombined.teamsDayWork.length }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Количество заказов:</span>
                <span class="summary-value highlight">{{ selectedOptimizationCombined.sessionOrders.length }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Средняя производительность:</span>
                <span class="summary-value highlight">
                  {{ selectedOptimizationCombined.totalQuantity / selectedOptimizationCombined.totalHours | number:'1.2-2' }} шт/ч
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Вторая строка: Работы бригад -->
      <div class="full-width-section">
        <div class="info-card rounded-card teams-card">
          <div class="card-header">
            <h3 class="card-title">Работы бригад ({{ selectedOptimizationCombined.teamsDayWork.length }})</h3>
          </div>
          <div class="card-content">

            <div class="teams-container">
              <div *ngFor="let teamWork of selectedOptimizationCombined.teamsDayWork"
                   class="team-accordion-item">

                <!-- Заголовок аккордеона бригады -->
                <div class="accordion-header team-header"
                     [class.expanded]="expandedTeamId === teamWork.team.id"
                     (click)="toggleTeamDetails(teamWork.team.id, teamWork)">
                  <div class="team-header-content">
                    <!-- Основная информация о бригаде -->
                    <div class="team-main-info">
                      <span class="team-name">{{ teamWork.team.name }}</span>
                      <span class="team-type">{{ getTeamTypeLabel(teamWork.team.teamType) }}</span>
                    </div>

                    <!-- Статистика бригады -->
                    <div class="team-stats">
                      <span class="team-stat">
                        <span class="stat-label">Сотрудники:</span>
                        <span class="stat-value">{{ teamWork.team.employeeCount }}</span>
                      </span>
                      <span class="team-stat">
                        <span class="stat-label">Макс. часов/день:</span>
                        <span class="stat-value">{{ teamWork.team.maxDailyHours }}</span>
                      </span>
                      <span class="team-stat">
                        <span class="stat-label">Работ:</span>
                        <span class="stat-value">{{ teamWork.ordersWork.length }}</span>
                      </span>
                      <span class="team-stat">
                        <span class="stat-label">Всего часов:</span>
                        <span class="stat-value">
                          {{ getTeamTotalHours(teamWork) | number:'1.2-2' }} ч
                        </span>
                      </span>
                      <span class="team-stat">
                        <span class="stat-label">Всего продукции:</span>
                        <span class="stat-value">
                          {{ getTeamTotalQuantity(teamWork) | number:'1.2-2' }} шт
                        </span>
                      </span>
                    </div>

                    <!-- Статус бригады -->
                    <div class="team-status">
                      <span class="status-badge" [class.active]="teamWork.team.active">
                        {{ teamWork.team.active ? 'Активна' : 'Неактивна' }}
                      </span>
                    </div>
                  </div>
                  <div class="accordion-icon">
                    <fa-icon [icon]="expandedTeamId === teamWork.team.id ? faChevronUp : faChevronDown"></fa-icon>
                  </div>
                </div>

                <!-- Контент аккордеона бригады -->
                <div *ngIf="expandedTeamId === teamWork.team.id" class="accordion-content team-content">
                  <!-- Детальная информация о бригаде -->
                  <div class="team-details-grid">
                    <div class="team-info-column">
                      <h5 class="details-subtitle">Информация о бригаде</h5>
                      <div class="info-row">
                        <span class="info-label">Название:</span>
                        <span class="info-value">{{ teamWork.team.name }}</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Тип команды:</span>
                        <span class="info-value">{{ getTeamTypeLabel(teamWork.team.teamType) }}</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Количество сотрудников:</span>
                        <span class="info-value">{{ teamWork.team.employeeCount }}</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Месячные часы:</span>
                        <span class="info-value">{{ teamWork.team.monthlyHours }}</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Макс. часов в день:</span>
                        <span class="info-value">{{ teamWork.team.maxDailyHours }}</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Статус:</span>
                        <span class="info-value">
                          <span class="status-badge" [class.active]="teamWork.team.active">
                            {{ teamWork.team.active ? 'Активна' : 'Неактивна' }}
                          </span>
                        </span>
                      </div>
                    </div>

                    <div class="team-stats-column">
                      <h5 class="details-subtitle">Статистика работ</h5>
                      <div class="info-row">
                        <span class="info-label">Всего работ:</span>
                        <span class="info-value">{{ teamWork.ordersWork.length }}</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Всего часов:</span>
                        <span class="info-value">{{ getTeamTotalHours(teamWork) | number:'1.2-2' }} ч</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Всего продукции:</span>
                        <span class="info-value">{{ getTeamTotalQuantity(teamWork) | number:'1.2-2' }} шт</span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Средняя производительность:</span>
                        <span class="info-value">
                          {{ getTeamTotalQuantity(teamWork) / getTeamTotalHours(teamWork) | number:'1.2-2' }} шт/ч
                        </span>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Уникальных продуктов:</span>
                        <span class="info-value">{{ getUniqueProductsCount(teamWork) }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Таблица работ бригады -->
                  <div class="team-works-table">
                    <h5 class="details-subtitle">Детализация работ</h5>
                    <div class="table-container">
                      <table class="works-table">
                        <thead>
                        <tr>
                          <th>Продукт</th>
                          <th>Тип производства</th>
                          <th>Индекс дня</th>
                          <th>Запланированные часы</th>
                          <th>Запланированное количество</th>
                          <th>Производительность (шт/ч)</th>
                          <th>Дата работы</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let work of teamWork.ordersWork">
                          <td class="product-cell">
                            <div class="product-info">
                              <span class="product-name">{{ work.product.name }}</span>
                              <span *ngIf="work.product.assemblyProductivity" class="product-productivity">
                                  ({{ work.product.assemblyProductivity }} шт/ч)
                                </span>
                            </div>
                          </td>
                          <td>{{ getProductionTypeLabel(work.productionType) }}</td>
                          <td>{{ work.dayIndex }}</td>
                          <td>{{ work.plannedHours | number:'1.2-2' }} ч</td>
                          <td>{{ work.plannedQuantity | number:'1.2-2' }} шт</td>
                          <td>{{ work.plannedQuantity / work.plannedHours | number:'1.2-2' }} шт/ч</td>
                          <td>{{ work.workDate | date:'dd.MM.yyyy' }}</td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr>
                          <td><strong>Итого:</strong></td>
                          <td></td>
                          <td></td>
                          <td><strong>{{ getTeamTotalHours(teamWork) | number:'1.2-2' }} ч</strong></td>
                          <td><strong>{{ getTeamTotalQuantity(teamWork) | number:'1.2-2' }} шт</strong></td>
                          <td>
                            <strong>
                              {{ getTeamTotalQuantity(teamWork) / getTeamTotalHours(teamWork) | number:'1.2-2' }} шт/ч
                            </strong>
                          </td>
                          <td></td>
                        </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Третья строка: Заказы сессии (остается как было, но адаптировано) -->
      <div class="full-width-section">
        <div class="info-card rounded-card session-card">
          <div class="card-header">
            <h3 class="card-title">Заказы сессии производства ({{ selectedOptimizationCombined.sessionOrders.length }})</h3>
          </div>
          <div class="card-content">
            <!-- Заказы в сессии -->
            <div class="session-orders-section">
              <div class="orders-container">
                <div *ngFor="let order of selectedOptimizationCombined.sessionOrders"
                     class="order-accordion-item">

                  <!-- Заголовок аккордеона заказа -->
                  <div class="accordion-header order-header"
                       [class.expanded]="expandedOrderId === order.id"
                       (click)="toggleOrderDetails(order.id)">
                    <div class="order-header-content">
                      <div class="order-main-info">
                        <span class="order-id">Заказ #{{ order.id }}</span>
                        <span class="order-product">{{ order.product.name }}</span>
                      </div>
                      <div class="order-secondary-info">
                        <span class="order-quantity">План: {{ order.quantity }} шт</span>
                        <span *ngIf="order.quantityFact !== null" class="order-quantity-fact">
                          Факт: {{ order.quantityFact }} шт
                        </span>
                        <span class="order-deadline">Дедлайн: {{ order.deadlineDate | date:'dd.MM.yyyy' }}</span>
                        <span class="order-type">Тип: {{ getProductionTypeLabel(order.productionType) }}</span>
                      </div>
                    </div>
                    <div class="accordion-icon">
                      <fa-icon [icon]="expandedOrderId === order.id ? faChevronUp : faChevronDown"></fa-icon>
                    </div>
                  </div>

                  <!-- Контент аккордеона заказа -->
                  <div *ngIf="expandedOrderId === order.id" class="accordion-content order-content">
                    <div class="order-details-grid">
                      <!-- Левая колонка: Информация о заказе -->
                      <div class="order-details-column">
                        <h5 class="details-subtitle">Информация о заказе</h5>
                        <div class="info-row">
                          <span class="info-label">ID:</span>
                          <span class="info-value">{{ order.id }}</span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Количество (план):</span>
                          <span class="info-value">{{ order.quantity }} шт</span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Количество (факт):</span>
                          <span class="info-value">{{ order.quantityFact !== null ? order.quantityFact + ' шт' : 'Не указано' }}</span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Осталось:</span>
                          <span class="info-value highlight">
                            {{ order.quantityFact !== null ? (order.quantity - order.quantityFact) + ' шт' : 'Неизвестно' }}
                          </span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Тип производства:</span>
                          <span class="info-value">{{ getProductionTypeLabel(order.productionType) }}</span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Дедлайн:</span>
                          <span class="info-value">{{ order.deadlineDate | date:'dd.MM.yyyy' }}</span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Источник:</span>
                          <span class="info-value">{{ order.source }}</span>
                        </div>
                      </div>

                      <!-- Правая колонка: Информация о продукте -->
                      <div class="order-details-column">
                        <h5 class="details-subtitle">Информация о продукте</h5>
                        <div class="info-row">
                          <span class="info-label">Наименование:</span>
                          <span class="info-value">{{ order.product.name }}</span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Производительность сборки:</span>
                          <span class="info-value">
                            {{ order.product.assemblyProductivity || 'Не указана' }}
                            <span *ngIf="order.product.assemblyProductivity">шт/ч</span>
                          </span>
                        </div>
                        <div class="info-row">
                          <span class="info-label">Статус:</span>
                          <span class="info-value">
                            <span class="status-badge" [class.active]="order.product.active">
                              {{ order.product.active ? 'Активен' : 'Неактивен' }}
                            </span>
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Бригады, работающие над этим заказом (опционально) -->
                    <div *ngIf="getTeamsWorkingOnOrder(order)" class="order-teams-info">
                      <h5 class="details-subtitle">Бригады, работающие над этим заказом</h5>
                      <div class="teams-chips">
                        <span *ngFor="let team of getTeamsWorkingOnOrder(order)" class="team-chip">
                          {{ team.team.name }} ({{ team.totalQuantity | number:'1.2-2' }} шт)
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showEmployeeStatusModal" class="employee-status-modal-overlay" (click)="closeEmployeeStatusModal()">
  <div class="employee-status-modal-content" (click)="$event.stopPropagation()">

    <!-- Заголовок модального окна -->
    <div class="employee-status-modal-header">
      <h2 class="employee-status-modal-title">
        <fa-icon [icon]="faUsers" style="margin-right: 10px; color: gray;"></fa-icon>
        Отметить отсутствующих сотрудников
      </h2>
      <button class="employee-status-modal-close" (click)="closeEmployeeStatusModal()">&times;</button>
    </div>

    <!-- Тело модального окна -->
    <div class="employee-status-modal-body">

      <!-- Статистика -->
      <div class="statistics-row">
        <div class="statistic-card">
          <div class="statistic-label">Всего команд</div>
          <div class="statistic-value">{{ teamsWithEmployees?.length || 0 }}</div>
        </div>
        <div class="statistic-card">
          <div class="statistic-label">Всего сотрудников</div>
          <div class="statistic-value">{{ getTotalEmployeesCount() }}</div>
        </div>
        <div class="statistic-card">
          <div class="statistic-label">Работают</div>
          <div class="statistic-value working">{{ getWorkingCount() }}</div>
        </div>
        <div class="statistic-card">
          <div class="statistic-label">Отсутствуют</div>
          <div class="statistic-value absent">{{ getAbsentCount() }}</div>
        </div>
      </div>

      <!-- Список команд -->
      <div class="teams-list">
        <div *ngFor="let teamData of teamsWithEmployees" class="team-item">

          <!-- Заголовок команды -->
          <div class="team-header" (click)="toggleTeam(teamData.team.id)">
            <div class="team-header-left">
              <div class="team-name">{{ teamData.team.name }}</div>
              <div class="team-info">
                <span class="team-type-badge" [ngClass]="teamData.team.teamType?.toLowerCase()">
                  {{ teamData.team.teamType === 'PRODUCTION' ? 'Производство' : 'Сборка' }}
                </span>
                <span class="team-employee-count">
                  <fa-icon [icon]="faUserFriends" style="margin-right: 4px;"></fa-icon>
                  {{ teamData.employees.length }} сотрудников
                </span>
              </div>
            </div>

            <div class="team-header-right">
              <div class="team-stats">
                <span class="team-stat working">
                  <fa-icon [icon]="faCheckCircle"></fa-icon>
                  {{ getTeamWorkingCount(teamData) }}
                </span>
                <span class="team-stat absent">
                  <fa-icon [icon]="faUserTimes"></fa-icon>
                  {{ getTeamAbsentCount(teamData) }}
                </span>
              </div>
              <div class="team-arrow">
                <fa-icon [icon]="expandedStatusTeamId === teamData.team.id ? faChevronUp : faChevronDown"></fa-icon>
              </div>
            </div>
          </div>

          <!-- Список сотрудников команды (раскрывается) -->
          <div *ngIf="expandedStatusTeamId === teamData.team.id" class="team-employees">
            <div class="employees-table-header">
              <div class="employee-name-header">Сотрудник</div>
              <div class="employee-status-header">Статус</div>
            </div>

            <div *ngFor="let employee of teamData.employees" class="employee-row">
              <div class="employee-info">
                <div class="employee-name">{{ employee.fullName }}</div>
                <div class="employee-details">
                  <span class="employee-position">{{ employee.position }}</span>
                  <span class="employee-qualification" *ngIf="employee.qualification">
                    Квалификация: {{ employee.qualification }}
                  </span>
                </div>
              </div>

              <div class="employee-actions">
                <div class="status-buttons">
                  <button class="status-btn working-btn"
                          [class.active]="employee.status === 'WORKING' || !employee.status"
                          (click)="setEmployeeStatus(employee, 'WORKING')"
                          title="Работает">
                    <fa-icon [icon]="faCheckCircle" style="color: gray;"></fa-icon>
                    <span class="btn-text">Работает</span>
                  </button>

                  <button class="status-btn absent-btn day-off"
                          [class.active]="employee.status === 'DAY_OFF'"
                          (click)="setEmployeeStatus(employee, 'DAY_OFF')"
                          title="Отгул">
                    <fa-icon [icon]="faCalendarAlt" style="color: gray;"></fa-icon>
                    <span class="btn-text">Отгул</span>
                  </button>

                  <button class="status-btn absent-btn sick"
                          [class.active]="employee.status === 'SICK'"
                          (click)="setEmployeeStatus(employee, 'SICK')"
                          title="Болезнь">
                    <fa-icon [icon]="faHospital" style="color: gray;"></fa-icon>
                    <span class="btn-text">Болезнь</span>
                  </button>
                </div>

                <div class="current-status" [ngClass]="getStatusClass(employee)">
                  {{ getStatusText(employee) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Футер модального окна -->
    <div class="employee-status-modal-footer">
      <div class="footer-left">
        <button class="btn btn-cancel" (click)="resetAllStatuses()">
          <fa-icon [icon]="faUndo"></fa-icon>
          Сбросить все
        </button>
      </div>

      <div class="footer-right">
        <button class="btn btn-primary"
                (click)="startOptimizationWithAbsences()">
          <fa-icon [icon]="faPlay"></fa-icon>
          Запустить оптимизацию
        </button>
      </div>
    </div>
  </div>
</div>
